name: Daily language learning

on:
  workflow_dispatch:
  schedule:
    # Runs daily at 08:00 JST (23:00 UTC).
    - cron: "0 23 * * *"

concurrency:
  group: daily-language-learning
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      # Prefer system CA bundle on Ubuntu runners (helps when certifi-based validation is flaky).
      SSL_CERT_FILE: /etc/ssl/certs/ca-certificates.crt
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Write config.json from Secrets
        shell: bash
        run: |
          set -euo pipefail
          cat > config.json <<JSON
          {
            "openai_api_key": "${{ secrets.OPENAI_API_KEY }}",
            "openai_model": "${{ secrets.OPENAI_MODEL || 'gpt-4o-mini' }}",
            "lark_app_id": "${{ secrets.LARK_APP_ID }}",
            "lark_app_secret": "${{ secrets.LARK_APP_SECRET }}",
            "lark_access_token": "",
            "lark_folder_token": "${{ secrets.LARK_FOLDER_TOKEN }}",
            "english_rss_url": "${{ secrets.ENGLISH_RSS_URL || 'https://feeds.arstechnica.com/arstechnica/index' }}",
            "netflix_rss_url": "${{ secrets.NETFLIX_RSS_URL || 'https://netflixtechblog.com/feed' }}",
            "netflix_rss_fallback_urls": ["https://medium.com/feed/netflix-techblog"],
            "netflix_max_chars": 12000,
            "netflix_verify_ssl": true,
            "netflix_ca_bundle": "",
            "netflix_allow_insecure_fallback": false,
            "netflix_allow_curl_fallback": false,
            "japanese_rss_url": "${{ secrets.JAPANESE_RSS_URL || 'https://www3.nhk.or.jp/rss/news/cat0.xml' }}",
            "max_english_items": 4,
            "request_timeout": 20
          }
          JSON

      - name: Run daily task
        run: |
          python daily_task.py
